[gd_scene load_steps=8 format=2]

[ext_resource path="res://GravityTools/weapons/GravityGun.gd" type="Script" id=1]
[ext_resource path="res://weapons/weapons-c.png" type="Texture" id=2]
[ext_resource path="res://weapons/weapons-n.png" type="Texture" id=3]
[ext_resource path="res://weapons/laser.wav" type="AudioStream" id=4]

[sub_resource type="CapsuleShape2D" id=1]
radius = 120.0
height = 700.0

[sub_resource type="Shader" id=2]
code = "shader_type canvas_item;
render_mode unshaded;

uniform float speed : hint_range(-5.0, 5.0) = -1.5;
uniform float intensity : hint_range(0.0, 1.0) = 1.0;
uniform vec4 primary_color : hint_color = vec4(0.15, 0.05, 0.25, 1.0);
uniform vec4 secondary_color : hint_color = vec4(0.3, 0.1, 0.4, 1.0);
uniform float ring_frequency : hint_range(2.0, 20.0) = 8.0;
uniform float ring_thickness : hint_range(0.1, 1.0) = 0.5;
uniform float turbulence : hint_range(0.0, 1.0) = 0.3;

varying vec2 v_pos;

void vertex() {
	v_pos = VERTEX;
}

void fragment() {
	float time = TIME * speed;
	
	// Distance from gun origin (0, 0) - creates concentric rings
	float dist = length(v_pos);
	
	// Normalize X for edge fade (beam width varies along length)
	// Approximate beam width at this Y position
	float beam_half_width = 20.0 + abs(v_pos.y) * 0.033; // Widens from 20 to ~40
	float norm_x = v_pos.x / beam_half_width;
	
	// Soft edge fade - gaussian-like falloff
	float edge_fade = exp(-norm_x * norm_x * 2.0);
	edge_fade = clamp(edge_fade, 0.0, 1.0);
	
	// Tip fade - fade out at the far end
	float tip_fade = smoothstep(-650.0, -400.0, v_pos.y);
	
	// Base fade - fade in from gun
	float base_fade = smoothstep(0.0, -80.0, v_pos.y);
	
	// Add turbulence distortion to ring distance
	float turb_offset = sin(v_pos.x * 0.05 + time * 2.0) * turbulence * 20.0;
	float turb_offset2 = cos(v_pos.y * 0.03 + time * 1.5) * turbulence * 15.0;
	float dist_distorted = dist + turb_offset + turb_offset2;
	
	// Concentric ring waves - rings expand outward from origin
	float ring1 = sin(dist_distorted * 0.015 * ring_frequency - time * 3.0);
	float ring2 = sin(dist_distorted * 0.02 * ring_frequency - time * 2.3 + 1.5);
	float ring3 = sin(dist_distorted * 0.01 * ring_frequency - time * 1.7 + 3.0);
	
	// Combine rings with varying weights
	float rings = ring1 * 0.5 + ring2 * 0.3 + ring3 * 0.2;
	rings = rings * 0.5 + 0.5; // Normalize to 0-1
	
	// Add some noise variation based on position
	float noise = sin(v_pos.x * 0.1 + v_pos.y * 0.05 + time) * 0.1;
	rings += noise;
	
	// Sharpen rings based on thickness
	float ring_pattern = smoothstep(0.5 - ring_thickness * 0.5, 0.5, rings) * 
	                     smoothstep(0.5 + ring_thickness * 0.5, 0.5, rings);
	ring_pattern = 1.0 - ring_pattern; // Invert for bright rings
	
	// Mix colors
	vec3 final_color = mix(primary_color.rgb, secondary_color.rgb, ring_pattern);
	
	// Combine all fades
	float alpha = edge_fade * tip_fade * base_fade * (0.2 + ring_pattern * 0.3) * intensity;
	alpha = clamp(alpha, 0.0, 0.4);
	
	COLOR = vec4(final_color, alpha);
}"

[sub_resource type="ShaderMaterial" id=3]
resource_local_to_scene = true
shader = SubResource( 2 )
shader_param/speed = -1.0
shader_param/intensity = 1.0
shader_param/primary_color = Color( 0.341176, 0.105882, 0.478431, 1 )
shader_param/secondary_color = Color( 0.713726, 0.219608, 1, 1 )
shader_param/ring_frequency = 4.0
shader_param/ring_thickness = 1.0
shader_param/turbulence = 0.41

[node name="GravityGun" type="Node2D"]
script = ExtResource( 1 )
powerDraw = 500000.0

[node name="Sprite" type="Sprite" parent="."]
position = Vector2( 0, -3 )
texture = ExtResource( 2 )
normal_map = ExtResource( 3 )
centered = false
offset = Vector2( -39, 0 )
region_enabled = true
region_rect = Rect2( 985, 108, 78, 300 )

[node name="GravityField" type="Area2D" parent="."]
collision_layer = 0
collision_mask = 2147483647
monitorable = false
gravity_point = true
linear_damp = 0.5
angular_damp = 0.5

[node name="CollisionShape2D" type="CollisionShape2D" parent="GravityField"]
position = Vector2( 0, -550 )
shape = SubResource( 1 )

[node name="BeamVisual" type="Polygon2D" parent="."]
material = SubResource( 3 )
position = Vector2( 5.84392, -45.681 )
scale = Vector2( 2.59083, 1.28432 )
polygon = PoolVector2Array( -49.7307, -27.5, 44.4475, -28.2787, 44.4475, -758.624, -49.3447, -760.181 )

[node name="AudioFire" type="AudioStreamPlayer" parent="."]
stream = ExtResource( 4 )
volume_db = -5.0
bus = "SFX"
